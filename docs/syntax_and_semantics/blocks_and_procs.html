<!DOCTYPE HTML>
<html lang="zn_cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>块和闭包 - Crystal 语言参考</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../installation/index.html"><strong aria-hidden="true">2.</strong> 安装</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/on_debian_and_ubuntu.html"><strong aria-hidden="true">2.1.</strong> 在 Debian 和 Ubuntu</a></li><li class="chapter-item expanded "><a href="../installation/on_redhat_and_centos.html"><strong aria-hidden="true">2.2.</strong> 在 RedHat 和 CentOS</a></li><li class="chapter-item expanded "><a href="../installation/on_arch_linux.html"><strong aria-hidden="true">2.3.</strong> 在 Arch Linux</a></li><li class="chapter-item expanded "><a href="../installation/on_gentoo_linux.html"><strong aria-hidden="true">2.4.</strong> 在 Gentoo Linux</a></li><li class="chapter-item expanded "><a href="../installation/on_mac_osx_using_homebrew.html"><strong aria-hidden="true">2.5.</strong> 在 Mac OSX 使用 Homebrew</a></li><li class="chapter-item expanded "><a href="../installation/on_linux_using_linuxbrew.html"><strong aria-hidden="true">2.6.</strong> 在 Linux 使用 Linuxbrew</a></li><li class="chapter-item expanded "><a href="../installation/on_bash_on_ubuntu_on_windows.html"><strong aria-hidden="true">2.7.</strong> 在 Windows 的 Ubuntu 子系统使用 Bash</a></li><li class="chapter-item expanded "><a href="../installation/on_native_windows.html"><strong aria-hidden="true">2.8.</strong> 在 Windows 原生环境</a></li><li class="chapter-item expanded "><a href="../installation/from_a_targz.html"><strong aria-hidden="true">2.9.</strong> 从 tar.gz</a></li><li class="chapter-item expanded "><a href="../installation/from_source_repository.html"><strong aria-hidden="true">2.10.</strong> 从源码编译</a></li></ol></li><li class="chapter-item expanded "><a href="../using_the_compiler/index.html"><strong aria-hidden="true">3.</strong> 使用编译器</a></li><li class="chapter-item expanded "><a href="../overview/index.html"><strong aria-hidden="true">4.</strong> 概览和例子</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../overview/hello_world.html"><strong aria-hidden="true">4.1.</strong> Hello World!</a></li><li class="chapter-item expanded "><a href="../overview/http_server.html"><strong aria-hidden="true">4.2.</strong> HTTP Server</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/index.html"><strong aria-hidden="true">5.</strong> 语法和语义</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/comments.html"><strong aria-hidden="true">5.1.</strong> 注释</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals.html"><strong aria-hidden="true">5.2.</strong> 字面量</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/nil.html"><strong aria-hidden="true">5.2.1.</strong> Nil</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/bool.html"><strong aria-hidden="true">5.2.2.</strong> Bool</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/integers.html"><strong aria-hidden="true">5.2.3.</strong> 整数</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/floats.html"><strong aria-hidden="true">5.2.4.</strong> 浮点数</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/char.html"><strong aria-hidden="true">5.2.5.</strong> 字符</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/string.html"><strong aria-hidden="true">5.2.6.</strong> 字符串</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/symbol.html"><strong aria-hidden="true">5.2.7.</strong> 符号</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/array.html"><strong aria-hidden="true">5.2.8.</strong> 数组</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/hash.html"><strong aria-hidden="true">5.2.9.</strong> 散列</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/range.html"><strong aria-hidden="true">5.2.10.</strong> 范围</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/regex.html"><strong aria-hidden="true">5.2.11.</strong> 正则表达式</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/tuple.html"><strong aria-hidden="true">5.2.12.</strong> 元组</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/named_tuple.html"><strong aria-hidden="true">5.2.13.</strong> 命名元组</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/literals/proc.html"><strong aria-hidden="true">5.2.14.</strong> 闭包</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/assignment.html"><strong aria-hidden="true">5.3.</strong> 赋值</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/multiple_assignment.html"><strong aria-hidden="true">5.3.1.</strong> 多重赋值</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/local_variables.html"><strong aria-hidden="true">5.4.</strong> 局部变量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/control_expressions.html"><strong aria-hidden="true">5.5.</strong> 控制结构</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/truthy_and_falsey_values.html"><strong aria-hidden="true">5.5.1.</strong> “真”与“假”值</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/if.html"><strong aria-hidden="true">5.5.2.</strong> if</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/as_a_suffix.html"><strong aria-hidden="true">5.5.2.1.</strong> 作为后缀</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/as_an_expression.html"><strong aria-hidden="true">5.5.2.2.</strong> 作为表达式</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/ternary_if.html"><strong aria-hidden="true">5.5.2.3.</strong> 三元 if 表达式</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/if_var.html"><strong aria-hidden="true">5.5.2.4.</strong> if 变量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/if_varis_a.html"><strong aria-hidden="true">5.5.2.5.</strong> if var.is_a?(...)</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/if_varresponds_to.html"><strong aria-hidden="true">5.5.2.6.</strong> if var.responds_to?(...)</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/if_var_nil.html"><strong aria-hidden="true">5.5.2.7.</strong> if var.nil?</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/not.html"><strong aria-hidden="true">5.5.2.8.</strong> if !</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/unless.html"><strong aria-hidden="true">5.5.3.</strong> unless</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/case.html"><strong aria-hidden="true">5.5.4.</strong> case</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/while.html"><strong aria-hidden="true">5.5.5.</strong> while</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/break.html"><strong aria-hidden="true">5.5.5.1.</strong> break</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/next.html"><strong aria-hidden="true">5.5.5.2.</strong> next</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/until.html"><strong aria-hidden="true">5.5.6.</strong> until</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/and.html"><strong aria-hidden="true">5.5.7.</strong> &&</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/or.html"><strong aria-hidden="true">5.5.8.</strong> ||</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/requiring_files.html"><strong aria-hidden="true">5.6.</strong> 导入文件</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/types_and_methods.html"><strong aria-hidden="true">5.7.</strong> 类型和方法</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/everything_is_an_object.html"><strong aria-hidden="true">5.7.1.</strong> 一切都是对象</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/the_program.html"><strong aria-hidden="true">5.7.2.</strong> Crystal 程序</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/classes_and_methods.html"><strong aria-hidden="true">5.7.3.</strong> 类和方法</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/new,_initialize_and_allocate.html"><strong aria-hidden="true">5.7.3.1.</strong> 实例化，初始化和内存分配</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/methods_and_instance_variables.html"><strong aria-hidden="true">5.7.3.2.</strong> 方法和实例变量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/type_inference.html"><strong aria-hidden="true">5.7.3.3.</strong> 类型推导</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/union_types.html"><strong aria-hidden="true">5.7.3.4.</strong> 联合类型</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/overloading.html"><strong aria-hidden="true">5.7.3.5.</strong> 重载</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/default_and_named_arguments.html"><strong aria-hidden="true">5.7.3.6.</strong> 命名参数和默认值</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/splats_and_tuples.html"><strong aria-hidden="true">5.7.3.7.</strong> 不定数目参数和元组展开</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/type_restrictions.html"><strong aria-hidden="true">5.7.3.8.</strong> 类型限制</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/return_types.html"><strong aria-hidden="true">5.7.3.9.</strong> 返回类型</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/default_values_named_arguments_splats_tuples_and_overloading.html"><strong aria-hidden="true">5.7.3.10.</strong> 方法形参详述</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/operators.html"><strong aria-hidden="true">5.7.3.11.</strong> 运算符</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/visibility.html"><strong aria-hidden="true">5.7.3.12.</strong> 可见性</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/inheritance.html"><strong aria-hidden="true">5.7.3.13.</strong> 继承</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/virtual_and_abstract_types.html"><strong aria-hidden="true">5.7.3.13.1.</strong> 虚类型和抽象类型</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/class_methods.html"><strong aria-hidden="true">5.7.3.14.</strong> 类方法</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/class_variables.html"><strong aria-hidden="true">5.7.3.15.</strong> 类变量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/finalize.html"><strong aria-hidden="true">5.7.3.16.</strong> finalize</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/modules.html"><strong aria-hidden="true">5.7.4.</strong> 模块</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/generics.html"><strong aria-hidden="true">5.7.5.</strong> 泛型</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/structs.html"><strong aria-hidden="true">5.7.6.</strong> 结构体</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/constants.html"><strong aria-hidden="true">5.7.7.</strong> 常量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/enum.html"><strong aria-hidden="true">5.7.8.</strong> 枚举</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/blocks_and_procs.html" class="active"><strong aria-hidden="true">5.7.9.</strong> 块和闭包</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/capturing_blocks.html"><strong aria-hidden="true">5.7.9.1.</strong> 捕获块</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/proc_literal.html"><strong aria-hidden="true">5.7.9.2.</strong> 闭包字面量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/block_forwarding.html"><strong aria-hidden="true">5.7.9.3.</strong> 传递块</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/closures.html"><strong aria-hidden="true">5.7.9.4.</strong> 闭包及其环境变量</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/alias.html"><strong aria-hidden="true">5.7.10.</strong> 别名</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/exception_handling.html"><strong aria-hidden="true">5.8.</strong> 异常处理</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/type_grammar.html"><strong aria-hidden="true">5.9.</strong> 类型语法</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/type_reflection.html"><strong aria-hidden="true">5.10.</strong> 类型反射</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/is_a.html"><strong aria-hidden="true">5.10.1.</strong> is_a?</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/nil_question.html"><strong aria-hidden="true">5.10.2.</strong> nil?</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/responds_to.html"><strong aria-hidden="true">5.10.3.</strong> responds_to?</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/as.html"><strong aria-hidden="true">5.10.4.</strong> as</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/as_question.html"><strong aria-hidden="true">5.10.5.</strong> as?</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/typeof.html"><strong aria-hidden="true">5.10.6.</strong> typeof</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/macros.html"><strong aria-hidden="true">5.11.</strong> 宏</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/macros/macro_methods.html"><strong aria-hidden="true">5.11.1.</strong> 宏方法</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/macros/hooks.html"><strong aria-hidden="true">5.11.2.</strong> 钩子</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/macros/fresh_variables.html"><strong aria-hidden="true">5.11.3.</strong> 宏内变量</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/attributes.html"><strong aria-hidden="true">5.12.</strong> 属性</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/low_level_primitives.html"><strong aria-hidden="true">5.13.</strong> 底层原语</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/pointerof.html"><strong aria-hidden="true">5.13.1.</strong> pointerof</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/sizeof.html"><strong aria-hidden="true">5.13.2.</strong> sizeof</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/instance_sizeof.html"><strong aria-hidden="true">5.13.3.</strong> instance_sizeof</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/declare_var.html"><strong aria-hidden="true">5.13.4.</strong> 声明未初始化的变量</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/compile_time_flags.html"><strong aria-hidden="true">5.14.</strong> 编译时标记</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/cross-compilation.html"><strong aria-hidden="true">5.14.1.</strong> 交叉编译</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/index.html"><strong aria-hidden="true">5.15.</strong> C语言绑定</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/lib.html"><strong aria-hidden="true">5.15.1.</strong> lib</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/fun.html"><strong aria-hidden="true">5.15.2.</strong> fun</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/out.html"><strong aria-hidden="true">5.15.2.1.</strong> out</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/to_unsafe.html"><strong aria-hidden="true">5.15.2.2.</strong> to_unsafe</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/struct.html"><strong aria-hidden="true">5.15.3.</strong> struct</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/union.html"><strong aria-hidden="true">5.15.4.</strong> union</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/enum.html"><strong aria-hidden="true">5.15.5.</strong> enum</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/variables.html"><strong aria-hidden="true">5.15.6.</strong> 变量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/constants.html"><strong aria-hidden="true">5.15.7.</strong> 常量</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/type.html"><strong aria-hidden="true">5.15.8.</strong> 类型</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/alias.html"><strong aria-hidden="true">5.15.9.</strong> 别名</a></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/c_bindings/callbacks.html"><strong aria-hidden="true">5.15.10.</strong> 回调</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax_and_semantics/unsafe.html"><strong aria-hidden="true">5.16.</strong> Unsafe 代码</a></li></ol></li><li class="chapter-item expanded "><a href="../conventions/index.html"><strong aria-hidden="true">6.</strong> 约定</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../conventions/coding_style.html"><strong aria-hidden="true">6.1.</strong> 代码风格</a></li><li class="chapter-item expanded "><a href="../conventions/documenting_code.html"><strong aria-hidden="true">6.2.</strong> 代码注释</a></li></ol></li><li class="chapter-item expanded "><a href="../database/index.html"><strong aria-hidden="true">7.</strong> 数据库</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../database/connection_pool.html"><strong aria-hidden="true">7.1.</strong> 连接池</a></li></ol></li><li class="chapter-item expanded "><a href="../guides/index.html"><strong aria-hidden="true">8.</strong> 导引</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guides/performance.html"><strong aria-hidden="true">8.1.</strong> 性能</a></li><li class="chapter-item expanded "><a href="../guides/concurrency.html"><strong aria-hidden="true">8.2.</strong> 并发</a></li><li class="chapter-item expanded "><a href="../guides/testing.html"><strong aria-hidden="true">8.3.</strong> 测试</a></li><li class="chapter-item expanded "><a href="../guides/writing_shards.html"><strong aria-hidden="true">8.4.</strong> 编写 Shards 包</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Crystal 语言参考</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="块和闭包"><a class="header" href="#块和闭包">块和闭包</a></h1>
<p>方法可以接受一个程序块，然后用 <code>yield</code>关键字执行它。例如：</p>
<pre><code class="language-crystal">def twice
  yield
  yield
end

twice do
  puts &quot;Hello!&quot;
end
</code></pre>
<p>上面的例子会打印 &quot;Hello!&quot;两次，每个 <code>yield</code>一次。</p>
<p>为了接受一个带有块的方法，只要在方法体中加入 <code>yield</code>，然后编译器会明白你的意图。 你可以加入一个块参数来让更明显地表述。块参数应当写在最后，并在名字前面加与号 (<code>&amp;</code>)：</p>
<pre><code class="language-crystal">def twice(&amp;block)
  yield
  yield
end
</code></pre>
<p>为了向这些方法传入块参数，你可以写 <code>do ... end</code> 或是 <code>{ ... }</code>，这两种写法等价：</p>
<pre><code class="language-crystal">twice() do
  puts &quot;Hello!&quot;
end

twice do
  puts &quot;Hello!&quot;
end

twice { puts &quot;Hello!&quot; }
</code></pre>
<p><code>do ... end</code> 和 <code>{ ... }</code> 之间的区别是 <code>do ... end</code> 绑定到最左面的调用，而 <code>{ ... }</code> 绑定到最右边的调用：</p>
<pre><code class="language-crystal">foo bar do
  something
end

# 上式等价于
foo(bar) do
  something
end

foo bar { something }

# 上式等价于

foo(bar { something })
</code></pre>
<p>这样你就可以用<code>do ... end</code>创建领域特定语言 (DSL) ，让他们看起来更像英语(或是你的母语)：</p>
<pre><code class="language-crystal">open file &quot;foo.cr&quot; do
  something
end

# 等同于:
open(file(&quot;foo.cr&quot;)) do
end
</code></pre>
<p>你不会喜欢写：</p>
<pre><code class="language-crystal">open(file(&quot;foo.cr&quot;) do
end)
</code></pre>
<h2 id="对于重载"><a class="header" href="#对于重载">对于重载</a></h2>
<p>如果两个方法名字相同，一个接受块，一个不接受，那么它们会被认为是两个不同的方法。详见<a href="overloading.html">重载</a> 一章。</p>
<h2 id="向块传递参数"><a class="header" href="#向块传递参数">向块传递参数</a></h2>
<p><code>yield</code> 表达式类似于调用，也可以接收参数。例如：</p>
<pre><code class="language-crystal">def twice
  yield 1
  yield 2
end

twice do |i|
  puts &quot;Got #{i}&quot;
end
</code></pre>
<p>它会打印 &quot;Got 1&quot; 和 &quot;Got 2&quot;。</p>
<p>也可以用花括号：</p>
<pre><code class="language-crystal">twice { |i| puts &quot;Got #{i}&quot; }
</code></pre>
<p>可以 <code>yield</code>多个值：</p>
<pre><code class="language-crystal">def many
  yield 1, 2, 3
end

many do |x, y, z|
  puts x + y + z
end

# 输出: 6
</code></pre>
<p>一个块可以不完全接受这些参数：</p>
<pre><code class="language-crystal">def many
  yield 1, 2, 3
end

many do |x, y|
  puts x + y
end

# 输出: 3
</code></pre>
<p>但如果接受超出了传送额度的参数，那就会产生错误：</p>
<pre><code class="language-crystal">def twice
  yield
  yield
end

twice do |i| # 错误: 块要求参数过多
end
</code></pre>
<p>每个块内变量的类型是该位置传进来所有变量类型的并。例如：</p>
<pre><code class="language-crystal">def some
  yield 1, 'a'
  yield true, &quot;hello&quot;
  yield 2, nil
end

some do |first, second|
  # first is Int32 | Bool
  # second is Char | String | Nil
end
</code></pre>
<p>快变量 <code>second</code> 也可以是 <code>Nil</code> ，因为最后一个 <code>yield</code> 表达式没有包含第二个参数。</p>
<h2 id="单参数块的简便写法"><a class="header" href="#单参数块的简便写法">单参数块的简便写法</a></h2>
<p>如果某个块只是接受一个参数，调用它的某个方法，那么有一个简便的方法表示它：</p>
<pre><code class="language-crystal">method do |argument|
  argument.some_method
end
</code></pre>
<p>可以这么写：</p>
<pre><code class="language-crystal">method &amp;.some_method
</code></pre>
<p>或是：</p>
<pre><code class="language-crystal">method(&amp;.some_method)
</code></pre>
<p>这只是个语法糖，不会产生性能损失。</p>
<p>也可以把参数传给 <code>some_method</code>：</p>
<pre><code class="language-crystal">method &amp;.some_method(arg1, arg2)
</code></pre>
<p>这也适用于运算符：</p>
<pre><code class="language-crystal">method &amp;.+(2)
method &amp;.[index]
</code></pre>
<h2 id="产出值"><a class="header" href="#产出值">产出值</a></h2>
<p><code>yield</code> 表达式本身也有值：块中的最后一个表达式的值。例如：</p>
<pre><code class="language-crystal">def twice
  v1 = yield 1
  puts v1

  v2 = yield 2
  puts v2
end

twice do |i|
  i + 1
end
</code></pre>
<p>上式会打印 &quot;2&quot; 和 &quot;3&quot;；</p>
<p><code>yield</code>表达式在变换换筛选值时尤其有用。最好的例子是 <a href="http://crystal-lang.org/api/Enumerable.html#map%28%26block%20%3A%20T%20-%3E%20U%29-instance-method">Enumerable#map</a> 和<a href="http://crystal-lang.org/api/Enumerable.html#select%28%26block%20%3A%20T%20-%3E%20%29-instance-method">Enumerable#select</a>：</p>
<pre><code class="language-crystal">ary = [1, 2, 3]
ary.map { |x| x + 1 }         #=&gt; [2, 3, 4]
ary.select { |x| x % 2 == 1 } #=&gt; [1, 3]
</code></pre>
<p>有一个形式上的转换方法：</p>
<pre><code class="language-crystal">def transform(value)
  yield value
end

transform(1) { |x| x + 1 } #=&gt; 2
</code></pre>
<p>最后一个表达式的结果是 <code>2</code>，因为 <code>transform</code>方法的最后一个表达式是 <code>yield</code>，它的值又是块的最后一个表达式。</p>
<h2 id="类型限制"><a class="header" href="#类型限制">类型限制</a></h2>
<p>使用 <code>yield</code> 的方法中，块的类型可以用 <code>&amp;block</code>的属性进行限制。例如：</p>
<pre><code class="language-crystal">def transform_int(start : Int32, &amp;block : Int32 -&gt; Int32)
  result = yield start
  result * 2
end

transform_int(3) { |x| x + 2 } #=&gt; 10
transform_int(3) { |x| &quot;foo&quot; } # 错误：块应该返回Int32，而不是String 
</code></pre>
<h2 id="break"><a class="header" href="#break">break</a></h2>
<p>块内的<code>break</code> 表达式可以提前跳出这个方法：</p>
<pre><code class="language-crystal">def thrice
  puts &quot;Before 1&quot;
  yield 1
  puts &quot;Before 2&quot;
  yield 2
  puts &quot;Before 3&quot;
  yield 3
  puts &quot;After 3&quot;
end

thrice do |i|
  if i == 2
    break
  end
end
</code></pre>
<p>上述程序打印 &quot;Before 1&quot;和 &quot;Before 2&quot;。这个 <code>thrice</code> 方法没有执行到 <code>puts &quot;Before 3&quot;</code>，因为 <code>break</code>让它早早地退出了。</p>
<p><code>break</code> 也可以接受参数，它将成为该方法的返回值。例如：</p>
<pre><code class="language-crystal">def twice
  yield 1
  yield 2
end

twice { |i| i + 1 } #=&gt; 3
twice { |i| break &quot;hello&quot; } #=&gt; &quot;hello&quot;
</code></pre>
<p>第一次方法调用的值是 3 ，因为 <code>twice</code>方法的最后一个表达式是 <code>yield</code>，它又从块中获得值。第二次调用的值是 &quot;hello&quot;，因为 <code>break</code>被执行了，它的参数成了返回值。</p>
<p>如果break在条件内，那么这个调用的返回类型会是块中所有可能返回的地方——比如<code>break</code>和最后一个表达式——的值类型的联合：</p>
<pre><code class="language-crystal">value = twice do |i|
  if i == 1
    break &quot;hello&quot;
  end
  i + 1
end
value #:: Int32 | String
</code></pre>
<p>如果<code>break</code> 接受了多个参数，那么它们自动组成一个 <a href="http://crystal-lang.org/api/Tuple.html">元组</a>:</p>
<pre><code class="language-crystal">values = twice { break 1, 2 }
values #=&gt; {1, 2}
</code></pre>
<p>如果<code>break</code> 没有收到参数，那么等同于接受一个 <code>nil</code>：</p>
<pre><code class="language-crystal">value = twice { break }
value #=&gt; nil
</code></pre>
<h2 id="next"><a class="header" href="#next">next</a></h2>
<p><code>next</code>表达式可以提前结束这个块 (而不是整个方法)。例如：</p>
<pre><code class="language-crystal">def twice
  yield 1
  yield 2
end

twice do |i|
  if i == 1
    puts &quot;Skipping 1&quot;
    next
  end

  puts &quot;Got #{i}&quot;
end

# 输出:
# Skipping 1
# Got 2
</code></pre>
<p><code>next</code> 表达式接收参数，这会传给<code>yield</code>的调用者：</p>
<pre><code class="language-crystal">def twice
  v1 = yield 1
  puts v1

  v2 = yield 2
  puts v2
end

twice do |i|
  if i == 1
    next 10
  end

  i + 1
end

# 输出
# 10
# 3
</code></pre>
<p>如果 <code>next</code>接收了多个参数，它们会自动组成一个 <a href="http://crystal-lang.org/api/Tuple.html">元组</a>。如果没有接收到值，那么等同于接受一个 <code>nil</code> 参数。</p>
<h2 id="with--yield"><a class="header" href="#with--yield">with ... yield</a></h2>
<p><code>yield</code>表达式可以用 <code>with</code> 关键字指定块中方法调用的接收者：</p>
<pre><code class="language-crystal">class Foo
  def one
    1
  end

  def yield_with_self
    with self yield
  end

  def yield_normally
    yield
  end
end

def one
  &quot;one&quot;
end

Foo.new.yield_with_self { one } # =&gt; 1
Foo.new.yield_normally { one }  # =&gt; &quot;one&quot;
</code></pre>
<h2 id="块参数解包"><a class="header" href="#块参数解包">块参数解包</a></h2>
<p>声明绿参数时可以用括号指定子参数：</p>
<pre><code class="language-crystal">array = [{1, &quot;one&quot;}, {2, &quot;two&quot;}]
array.each do |(number, word)|
  puts &quot;#{number}: #{word}&quot;
end
</code></pre>
<p>这是下面这种写法的语法糖：</p>
<pre><code class="language-crystal">array = [{1, &quot;one&quot;}, {2, &quot;two&quot;}]
array.each do |arg|
  number = arg[0]
  word = arg[1]
  puts &quot;#{number}: #{word}&quot;
end
</code></pre>
<p>这也意味着任何可以以整数为参数响应 <code>[]</code> 方法的对象都可以在这里解包。</p>
<h2 id="性能"><a class="header" href="#性能">性能</a></h2>
<p>当以 <code>yield</code>使用块时，这个块 <strong>总是</strong> 被内联：不会涉及闭包，调用，或是函数指针。这意味着：</p>
<pre><code class="language-crystal">def twice
  yield 1
  yield 2
end

twice do |i|
  puts &quot;Got: #{i}&quot;
end
</code></pre>
<p>等同于写：</p>
<pre><code class="language-crystal">i = 1
puts &quot;Got: #{i}&quot;
i = 2
puts &quot;Got: #{i}&quot;
</code></pre>
<p>例如，标准库对整数添加了 <code>times</code> 方法，你可以写：</p>
<pre><code class="language-crystal">3.times do |i|
  puts i
end
</code></pre>
<p>这看起来非常花哨，但是它确实和C的循环一样快，真的。</p>
<p>这是 <code>Int#times</code> 的定义：</p>
<pre><code class="language-crystal">struct Int
  def times
    i = 0
    while i &lt; self
      yield i
      i += 1
    end
  end
end
</code></pre>
<p>因为没有被捕获的块总是被内联，上面的方法调用 <strong>等同于</strong> 写：</p>
<pre><code class="language-crystal">i = 0
while i &lt; 3
  puts i
  i += 1
end
</code></pre>
<p>使用块不用担心它的性能问题，但确实能提升代码可读性和重用性。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../syntax_and_semantics/enum.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../syntax_and_semantics/capturing_blocks.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../syntax_and_semantics/enum.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../syntax_and_semantics/capturing_blocks.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
